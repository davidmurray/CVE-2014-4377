#include <stdlib.h>
#include <substrate.h>

extern "C" void *x_calloc(size_t times, size_t size);

MSHook(void *, x_calloc, size_t times, size_t size)
{
	unsigned int total = (size * times + 31) & 0xFFFFFFF0;
	unsigned long long check = size * (unsigned long long)times;
	//NSLog(@"Hooking x_calloc...%lu * %lu (%u, %llu)", times, size, total, check);

	if ((size | times) < 0x10000 || total >= check) {
		return _x_calloc(times, size);
	} else {
		return NULL;
	}
}

MSInitialize
{
	NSLog(@"[CVE-2014-4377]: Loaded.");

	MSImageRef image = MSGetImageByName("/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics");
	if (!image)
		return;

	MSHookFunction(MSFindSymbol(image, "_x_calloc"), MSHake(x_calloc));
}