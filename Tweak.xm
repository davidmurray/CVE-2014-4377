#include <stdlib.h>
#include <substrate.h>

extern "C" void *x_calloc(size_t times, size_t size);

MSHook(void *, x_calloc, size_t times, size_t size)
{
	unsigned int total;
	unsigned long long check;

	total = (size * times + 31) & 0xFFFFFFF0;
	check = size * (unsigned long long)times;
	//NSLog(@"Hooking x_calloc...%lu * %lu (%u, %llu)", times, size, total, check);

	if ((size | times) < 0x10000 || total >= check) {
		return _x_calloc(times, size);
	} else {
		return NULL;
	}
}

%ctor
{
	MSHookFunction(MSFindSymbol(MSGetImageByName("/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics"), "_x_calloc"), MSHake(x_calloc));
}